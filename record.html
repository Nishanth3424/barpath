<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Record - Barpath Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --neon-blue: #2F80ED; --glass-bg: rgba(20, 20, 25, 0.9); }
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* Recording Pulse */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        
        /* Trimmer Styles */
        .timeline-container { position: relative; height: 60px; background: #1f2937; border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .selection-box { position: absolute; top: 0; bottom: 0; background: rgba(47, 128, 237, 0.2); border: 2px solid #2F80ED; border-radius: 8px; box-shadow: 0 0 10px rgba(47, 128, 237, 0.3); }
        .handle { position: absolute; top: 0; bottom: 0; width: 20px; background: #2F80ED; display: flex; align-items: center; justify-content: center; z-index: 20; }
        .handle::after { content: ''; width: 2px; height: 20px; background: rgba(255,255,255,0.5); border-radius: 2px; }
        .handle-left { left: 0; border-radius: 6px 0 0 6px; }
        .handle-right { right: 0; border-radius: 0 6px 6px 0; }
        .playhead { position: absolute; top: 0; bottom: 0; width: 2px; background: white; pointer-events: none; z-index: 10; box-shadow: 0 0 4px black; }
        .thumbnail-strip { display: flex; height: 100%; opacity: 0.5; }
        .thumbnail-strip div { flex: 1; border-right: 1px solid rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="step-record" class="h-screen flex flex-col relative">
        <div class="absolute top-0 left-0 right-0 p-6 z-20 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent">
            <button onclick="window.location.href='index.html'" class="p-3 rounded-full bg-white/10 backdrop-blur border border-white/10">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <div id="recordingTimer" class="hidden px-4 py-1 bg-red-600 rounded-full font-mono font-bold tracking-widest text-sm shadow-lg shadow-red-900/50">00:00</div>
            <div class="w-12"></div>
        </div>

        <video id="livePreview" autoplay playsinline muted class="w-full h-full object-cover bg-gray-900"></video>

        <div class="absolute bottom-0 left-0 right-0 p-8 pb-12 flex flex-col items-center bg-gradient-to-t from-black/90 to-transparent">
            <p class="text-gray-400 text-xs font-medium mb-6 bg-black/50 px-3 py-1 rounded-full border border-white/10">
                Position camera 6ft away â€¢ Side view
            </p>
            <button id="recordBtn" onclick="toggleRecording()" class="w-20 h-20 rounded-full border-[6px] border-white/20 flex items-center justify-center transition-all active:scale-95">
                <div id="recordInner" class="w-14 h-14 rounded-full bg-red-500 transition-all shadow-lg shadow-red-600/30"></div>
            </button>
        </div>
    </div>

    <div id="step-trim" class="hidden h-screen flex flex-col bg-black">
        <div class="p-4 flex items-center gap-4 border-b border-white/10 bg-gray-900/50">
            <button onclick="retake()" class="p-2 rounded-lg hover:bg-white/10"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h1 class="font-bold text-lg">Review Clip</h1>
        </div>

        <div class="flex-1 relative flex items-center justify-center bg-gray-900 overflow-hidden">
            <video id="recordedPreview" playsinline class="max-h-full max-w-full"></video>
        </div>

        <div class="bg-gray-900 border-t border-white/10 p-6 pb-safe">
            
            <div class="flex justify-between text-xs font-mono text-gray-400 mb-2">
                <span>Selected: <span id="clipDuration" class="text-blue-400 font-bold">0.0s</span></span>
                <span>Total: <span id="totalDuration">0:00</span></span>
            </div>

            <div class="timeline-container" id="timeline">
                <div class="thumbnail-strip" id="thumbnailStrip"></div>
                <div class="selection-box" id="selectionBox">
                    <div class="handle handle-left" id="handleLeft"></div>
                    <div class="handle handle-right" id="handleRight"></div>
                </div>
                <div class="playhead" id="playhead"></div>
            </div>

            <div class="mt-6 mb-4">
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setLift('clean')" id="btn-clean" class="lift-btn py-2 rounded-lg text-xs font-bold border border-white/10 bg-white/5 text-gray-400">CLEAN</button>
                    <button onclick="setLift('snatch')" id="btn-snatch" class="lift-btn py-2 rounded-lg text-xs font-bold border border-white/10 bg-white/5 text-gray-400">SNATCH</button>
                    <button onclick="setLift('jerk')" id="btn-jerk" class="lift-btn py-2 rounded-lg text-xs font-bold border border-white/10 bg-white/5 text-gray-400">JERK</button>
                    <button onclick="setLift('squat')" id="btn-squat" class="lift-btn py-2 rounded-lg text-xs font-bold border border-white/10 bg-white/5 text-gray-400">SQUAT</button>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="previewClip()" class="flex-1 py-4 rounded-xl bg-gray-800 text-white font-bold text-sm flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-4 h-4"></i> Preview
                </button>
                <button id="analyzeBtn" onclick="analyzeClip()" class="flex-[2] py-4 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-600/30">
                    Analyze Lift
                </button>
            </div>

            <div id="progressArea" class="hidden mt-4">
                <div class="flex justify-between text-xs text-blue-400 mb-1">
                    <span id="progressText">Uploading...</span>
                    <span><i data-lucide="loader-2" class="w-3 h-3 animate-spin inline"></i></span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-1.5 overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // --- CONFIG ---
        const API_URL = 'https://gamercheetah24--barpath-analyzer-v2-web.modal.run/api';

        // --- DATABASE LOGIC ---
        const dbName = "BarpathDB"; const storeName = "videos"; const DB_VERSION = 2;
        function openDB(){return new Promise((r,j)=>{const q=indexedDB.open(dbName,DB_VERSION);q.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains(storeName))d.createObjectStore(storeName)};q.onsuccess=e=>r(e.target.result);q.onerror=e=>j(e.target.error)})}
        async function saveVideoToDB(id,b64){try{const db=await openDB(),tx=db.transaction(storeName,"readwrite");tx.objectStore(storeName).put(b64,id)}catch(e){console.error(e)}}

        // --- STATE ---
        let mediaRecorder, recordedChunks = [], isRecording = false, stream, recordedBlob, videoDuration = 0;
        let trimStart = 0, trimEnd = 5, currentLift = 'clean';
        let isDragging = null, dragStartX = 0, dragStartLeft = 0, dragStartRight = 0;

        // --- CAMERA ---
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 } }, audio: false });
                document.getElementById('livePreview').srcObject = stream;
            } catch (e) { alert("Camera access denied. Please check settings."); }
        }

        // --- RECORDING ---
        function toggleRecording() {
            if (isRecording) stopRecording();
            else startRecording();
        }

        function startRecording() {
            recordedChunks = [];
            const mime = MediaRecorder.isTypeSupported("video/webm;codecs=vp8") ? "video/webm;codecs=vp8" : "video/webm";
            mediaRecorder = new MediaRecorder(stream, { mimeType: mime });
            
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                recordedBlob = new Blob(recordedChunks, { type: mime });
                showTrim();
            };
            
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('recordingTimer').classList.remove('hidden');
            document.getElementById('recordInner').classList.add('recording-pulse', 'rounded-lg', 'scale-75');
            startTimer();
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('recordingTimer').classList.add('hidden');
            document.getElementById('recordInner').classList.remove('recording-pulse', 'rounded-lg', 'scale-75');
            stopTimer();
        }

        let timerInt;
        function startTimer() {
            const start = Date.now();
            timerInt = setInterval(() => {
                const s = Math.floor((Date.now() - start) / 1000);
                document.getElementById('recordingTimer').textContent = `00:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInt); }

        // --- TRIMMER UI ---
        function showTrim() {
            document.getElementById('step-record').classList.add('hidden');
            document.getElementById('step-trim').classList.remove('hidden');
            const v = document.getElementById('recordedPreview');
            v.src = URL.createObjectURL(recordedBlob);
            v.onloadedmetadata = () => {
                videoDuration = isFinite(v.duration) ? v.duration : 10;
                trimEnd = Math.min(5, videoDuration);
                document.getElementById('totalDuration').textContent = videoDuration.toFixed(1) + 's';
                updateTrimUI();
                generateThumbnails();
            };
        }

        function retake() {
            document.getElementById('step-trim').classList.add('hidden');
            document.getElementById('step-record').classList.remove('hidden');
            recordedBlob = null;
        }

        function updateTrimUI() {
            const pctStart = (trimStart / videoDuration) * 100;
            const pctEnd = (trimEnd / videoDuration) * 100;
            const box = document.getElementById('selectionBox');
            box.style.left = pctStart + '%';
            box.style.width = (pctEnd - pctStart) + '%';
            document.getElementById('clipDuration').textContent = (trimEnd - trimStart).toFixed(1) + 's';
        }

        function generateThumbnails() {
            const strip = document.getElementById('thumbnailStrip');
            strip.innerHTML = '';
            for(let i=0; i<20; i++) {
                const d = document.createElement('div');
                d.style.background = `hsl(${220}, 20%, ${10 + Math.random()*20}%)`;
                strip.appendChild(d);
            }
        }

        // --- TOUCH DRAG LOGIC ---
        const timeline = document.getElementById('timeline');
        
        const handleDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = timeline.getBoundingClientRect();
            const deltaSec = ((clientX - dragStartX) / rect.width) * videoDuration;

            if (isDragging === 'left') trimStart = Math.max(0, Math.min(trimEnd - 1, dragStartLeft + deltaSec));
            if (isDragging === 'right') trimEnd = Math.max(trimStart + 1, Math.min(videoDuration, dragStartRight + deltaSec));
            if (isDragging === 'box') {
                const dur = dragStartRight - dragStartLeft;
                let newStart = dragStartLeft + deltaSec;
                if (newStart < 0) newStart = 0;
                if (newStart + dur > videoDuration) newStart = videoDuration - dur;
                trimStart = newStart;
                trimEnd = newStart + dur;
            }
            updateTrimUI();
        };

        const startDrag = (mode, e) => {
            isDragging = mode;
            dragStartX = e.touches ? e.touches[0].clientX : e.clientX;
            dragStartLeft = trimStart;
            dragStartRight = trimEnd;
        };

        document.getElementById('handleLeft').addEventListener('mousedown', e => startDrag('left', e));
        document.getElementById('handleLeft').addEventListener('touchstart', e => startDrag('left', e));
        document.getElementById('handleRight').addEventListener('mousedown', e => startDrag('right', e));
        document.getElementById('handleRight').addEventListener('touchstart', e => startDrag('right', e));
        document.getElementById('selectionBox').addEventListener('mousedown', e => { if(e.target.id==='selectionBox') startDrag('box', e) });
        document.getElementById('selectionBox').addEventListener('touchstart', e => { if(e.target.id==='selectionBox') startDrag('box', e) });
        window.addEventListener('mousemove', handleDrag);
        window.addEventListener('touchmove', handleDrag);
        window.addEventListener('mouseup', () => isDragging = null);
        window.addEventListener('touchend', () => isDragging = null);

        // --- PREVIEW ---
        function previewClip() {
            const v = document.getElementById('recordedPreview');
            v.currentTime = trimStart;
            v.play();
            const check = setInterval(() => {
                if (v.currentTime >= trimEnd) { v.pause(); clearInterval(check); }
                const pct = (v.currentTime / videoDuration) * 100;
                document.getElementById('playhead').style.left = pct + '%';
            }, 50);
        }

        // --- LIFT SELECTION ---
        function setLift(type) {
            currentLift = type;
            document.querySelectorAll('.lift-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'border-blue-500');
                b.classList.add('bg-white/5', 'text-gray-400', 'border-white/10');
            });
            const btn = document.getElementById('btn-' + type);
            btn.classList.remove('bg-white/5', 'text-gray-400', 'border-white/10');
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-500');
        }
        setLift('clean');

        // --- ANALYZE (CRITICAL FIX FOR STORAGE CRASH) ---
        async function analyzeClip() {
            const dur = trimEnd - trimStart;
            if (dur > 15) return alert("Clip must be under 15 seconds.");

            const btn = document.getElementById('analyzeBtn');
            const prog = document.getElementById('progressArea');
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('progressText');

            btn.disabled = true;
            btn.classList.add('opacity-50');
            prog.classList.remove('hidden');
            
            // Convert to Base64
            txt.textContent = "Encoding...";
            bar.style.width = "20%";
            
            const reader = new FileReader();
            reader.readAsDataURL(recordedBlob);
            reader.onload = async () => {
                try {
                    const b64 = reader.result.split(',')[1];
                    
                    txt.textContent = "Analyzing on GPU (~60s)...";
                    bar.style.width = "40%";

                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            video: b64,
                            lift_type: currentLift,
                            filename: `rec_${Date.now()}.webm`
                        })
                    });

                    if (!res.ok) throw new Error("Server error");
                    const data = await res.json();

                    if (data.success) {
                        bar.style.width = "90%";
                        txt.textContent = "Saving...";
                        
                        const id = Date.now();
                        
                        // 1. Save HEAVY video to IndexedDB (Not LocalStorage)
                        if (data.rendered_video) {
                            await saveVideoToDB(id, data.rendered_video);
                        }

                        // 2. Prepare Lightweight Result for LocalStorage
                        const safeResult = { ...data };
                        delete safeResult.rendered_video; // CRITICAL: Remove video to prevent crash
                        
                        // 3. Save to History
                        const hist = JSON.parse(localStorage.getItem('liftHistory') || '[]');
                        hist.unshift({
                            id: id,
                            date: new Date().toISOString(),
                            lift: currentLift,
                            score: Math.round(data.metrics?.technique_score || 0),
                            resultData: safeResult
                        });
                        localStorage.setItem('liftHistory', JSON.stringify(hist.slice(0, 20)));

                        // 4. Set "Last Result" pointers
                        localStorage.setItem('lastResult', JSON.stringify(safeResult));
                        localStorage.setItem('lastResultId', id);

                        window.location.href = 'results.html';
                    } else {
                        throw new Error(data.error);
                    }
                } catch (e) {
                    alert("Analysis Failed: " + e.message);
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    prog.classList.add('hidden');
                }
            };
        }

        initCamera();
    </script>
</body>
</html>