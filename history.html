<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Barpath Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.1); --glass-bg: rgba(20, 20, 25, 0.7); }
        body { font-family: -apple-system, sans-serif; background: #000; color: white; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
    </style>
</head>
<body class="pb-24">
    <div class="fixed inset-0 bg-gradient-to-b from-blue-900/10 to-black -z-10"></div>

    <div class="max-w-lg mx-auto px-6 py-8">
        <h1 class="text-3xl font-bold mb-8 tracking-tight">Lift History</h1>
        <div id="historyList" class="space-y-4"></div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 glass-panel border-t border-white/5 pb-safe z-50">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="index.html" class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Home</span>
            </a>
            <a href="#" class="flex flex-col items-center gap-1 text-blue-400">
                <i data-lucide="history" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">History</span>
            </a>
            <a href="settings.html" class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Settings</span>
            </a>
        </div>
    </nav>

    <script>
        lucide.createIcons();
        
        // CHANGED: Version 2 -> 3
        function openDB(){return new Promise(r=>{const q=indexedDB.open("BarpathDB",3);q.onsuccess=e=>r(e.target.result);q.onerror=()=>r(null)})}

        async function loadHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('liftHistory') || '[]');

            if (history.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-500 mt-20">No history yet.</div>`;
                return;
            }

            list.innerHTML = history.map((lift, i) => `
                <div onclick="viewLift(${i})" class="glass-panel p-5 rounded-3xl active:scale-95 transition-transform cursor-pointer group">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-900/30 flex items-center justify-center text-blue-400 font-bold text-xs uppercase border border-blue-500/30">
                                ${lift.lift ? lift.lift.substring(0,2) : 'CL'}
                            </div>
                            <div>
                                <div class="font-bold text-sm text-white">${new Date(lift.date).toLocaleDateString()}</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wider font-medium">${lift.lift || 'Clean'}</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600 group-hover:text-white transition-colors"></i>
                    </div>
                    <div class="grid grid-cols-3 gap-2 border-t border-white/5 pt-3">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Score</div>
                            <div class="text-lg font-bold text-green-400">${lift.score || '-'}</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Vel</div>
                            <div class="text-lg font-bold text-blue-400">${lift.velocity || '-'}</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Time</div>
                            <div class="text-lg font-bold text-white">${lift.duration || '-'}s</div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function viewLift(i) {
            const history = JSON.parse(localStorage.getItem('liftHistory') || '[]');
            const lift = history[i];
            
            if (lift) {
                localStorage.setItem('lastResultId', lift.id);
                const meta = {
                    metrics: {
                        technique_score: lift.score,
                        peak_velocity: lift.velocity,
                        duration: parseFloat(lift.duration)
                    }
                };
                localStorage.setItem('lastResultMeta', JSON.stringify(meta));
                window.location.href = 'results.html';
            }
        }
        loadHistory();
    </script>
</body>
</html>