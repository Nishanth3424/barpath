<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - Barpath Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.1); --glass-bg: rgba(20, 20, 25, 0.7); }
        body { font-family: -apple-system, sans-serif; background: #000; color: white; overflow-x: hidden; }
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle at 50% 100%, #1a237e 0%, #000000 70%); z-index: -1; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
    </style>
</head>
<body class="min-h-screen">
    <div class="mesh-bg"></div>

    <div class="max-w-lg mx-auto px-6 py-8">
        <div class="flex items-center gap-4 mb-8">
            <button onclick="window.location.href='index.html'" class="p-3 rounded-full hover:bg-white/10 glass-panel">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h1 class="text-2xl font-bold tracking-tight">Upload Lift</h1>
        </div>

        <div id="uploadZone" class="glass-panel border-dashed border-2 border-white/20 rounded-[32px] p-12 text-center cursor-pointer hover:bg-white/5 transition-all aspect-square flex flex-col items-center justify-center mb-8" onclick="document.getElementById('fileIn').click()">
            <input type="file" id="fileIn" class="hidden" accept="video/*" onchange="handleFileSelect(this)">
            <div id="emptyState">
                <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-blue-600/20 flex items-center justify-center animate-pulse">
                    <i data-lucide="upload-cloud" class="w-10 h-10 text-blue-400"></i>
                </div>
                <p class="font-bold text-lg mb-2">Tap to Select Video</p>
                <p class="text-sm text-gray-500">MP4 or MOV â€¢ Max 25MB</p>
            </div>
            <div id="fileState" class="hidden">
                <i data-lucide="film" class="w-12 h-12 text-green-400 mx-auto mb-4"></i>
                <p class="text-xl font-bold mb-2" id="fileName">video.mp4</p>
                <p class="text-sm text-green-400 font-medium">Ready to analyze</p>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-3 mb-8">
            <button onclick="setLift('clean')" id="btn-clean" class="lift-btn p-4 rounded-2xl glass-panel text-xs font-bold hover:bg-white/10 transition-all border-blue-500 bg-blue-900/20">CLEAN</button>
            <button onclick="setLift('snatch')" id="btn-snatch" class="lift-btn p-4 rounded-2xl glass-panel text-xs font-bold hover:bg-white/10 transition-all text-gray-400">SNATCH</button>
            <button onclick="setLift('jerk')" id="btn-jerk" class="lift-btn p-4 rounded-2xl glass-panel text-xs font-bold hover:bg-white/10 transition-all text-gray-400">JERK</button>
            <button onclick="setLift('squat')" id="btn-squat" class="lift-btn p-4 rounded-2xl glass-panel text-xs font-bold hover:bg-white/10 transition-all text-gray-400">SQUAT</button>
        </div>

        <button id="analyzeBtn" onclick="uploadAndAnalyze()" disabled class="w-full py-5 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-3xl font-bold text-lg transition-all shadow-lg shadow-blue-900/50 flex items-center justify-center gap-2">
            <i data-lucide="sparkles" class="w-5 h-5"></i> Analyze Lift
        </button>
        
        <div id="progressArea" class="hidden mt-6">
            <div class="flex justify-between text-xs text-blue-400 mb-2 font-mono">
                <span id="progressText">UPLOADING...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-900 rounded-full h-2 overflow-hidden border border-white/10">
                <div id="progressBar" class="bg-blue-500 h-full w-0 transition-all duration-300 shadow-[0_0_10px_#3b82f6]"></div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API_URL = 'https://gamercheetah24--barpath-analyzer-v2-web.modal.run/api';
        let currentLift = 'clean';
        let selectedFile = null;

        // --- DATABASE INIT ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open("BarpathDB", 2);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains("videos")) db.createObjectStore("videos");
                    if (!db.objectStoreNames.contains("graphs")) db.createObjectStore("graphs"); // NEW STORE
                };
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = (e) => reject(e);
            });
        }

        function setLift(type) {
            currentLift = type;
            document.querySelectorAll('.lift-btn').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-900/20', 'text-white');
                b.classList.add('text-gray-400');
            });
            const active = document.getElementById('btn-' + type);
            active.classList.add('border-blue-500', 'bg-blue-900/20', 'text-white');
            active.classList.remove('text-gray-400');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('fileState').classList.remove('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        async function uploadAndAnalyze() {
            if (!selectedFile) return;
            const btn = document.getElementById('analyzeBtn');
            const progress = document.getElementById('progressArea');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');

            btn.disabled = true;
            progress.classList.remove('hidden');
            bar.style.width = '10%';

            const reader = new FileReader();
            reader.readAsDataURL(selectedFile);
            
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                text.textContent = "PROCESSING ON GPU (~60s)...";
                bar.style.width = '40%';
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            video: base64,
                            lift_type: currentLift,
                            filename: selectedFile.name
                        })
                    });

                    if (!response.ok) throw new Error("Server error");
                    const result = await response.json();

                    if (result.success) {
                        bar.style.width = '100%';
                        text.textContent = "SAVING...";
                        
                        const liftId = Date.now();
                        
                        // 1. Prepare Light Metadata (Metrics only)
                        const lightResult = { ...result };
                        delete lightResult.rendered_video; // Heavy
                        delete lightResult.graphs;         // Heavy
                        
                        // 2. Save Heavy Data to IndexedDB
                        const db = await openDB();
                        const tx = db.transaction(["videos", "graphs"], "readwrite");
                        
                        if (result.rendered_video) {
                            tx.objectStore("videos").put(result.rendered_video, liftId);
                        }
                        if (result.graphs) {
                            tx.objectStore("graphs").put(result.graphs, liftId);
                        }

                        // 3. Save Light Data to LocalStorage
                        await new Promise((resolve) => {
                            tx.oncomplete = resolve;
                            tx.onerror = resolve; // Continue even if DB fails
                        });

                        localStorage.setItem('lastResultId', liftId);
                        localStorage.setItem('lastResultMeta', JSON.stringify(lightResult)); // Only metrics
                        
                        // 4. Update History
                        const history = JSON.parse(localStorage.getItem('liftHistory') || '[]');
                        history.unshift({
                            id: liftId,
                            date: new Date().toISOString(),
                            lift: currentLift,
                            score: Math.round(result.metrics?.technique_score || 0),
                            velocity: Math.round(result.metrics?.peak_velocity || 0),
                            duration: (result.metrics?.duration || 0).toFixed(1)
                        });
                        localStorage.setItem('liftHistory', JSON.stringify(history.slice(0, 20)));

                        window.location.href = 'results.html';
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    alert("Error: " + e.message);
                    btn.disabled = false;
                    progress.classList.add('hidden');
                }
            };
        }
    </script>
</body>
</html>