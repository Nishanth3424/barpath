<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analysis - Barpath Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.1); --glass-bg: rgba(20, 20, 25, 0.7); --neon-blue: #2F80ED; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; background: #000; color: white; -webkit-font-smoothing: antialiased; }
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle at 50% 0%, #1a237e 0%, #000000 80%); z-index: -1; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
        .delay-100 { animation-delay: 0.1s; } .delay-200 { animation-delay: 0.2s; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-32">
    <div class="mesh-bg"></div>

    <nav class="fixed top-0 left-0 right-0 z-50 px-4 py-4 glass-panel border-b-0 bg-black/50">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <button onclick="window.location.href='index.html'" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                <i data-lucide="arrow-left" class="w-6 h-6 text-white"></i>
            </button>
            <span class="font-semibold tracking-wide">Analysis Results</span>
            <div class="w-10"></div>
        </div>
    </nav>

    <div class="max-w-lg mx-auto px-6 pt-24" id="content">
        <div class="text-center py-20 text-gray-500">
            <div class="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            Loading Intelligence...
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // --- DB HELPERS (VERSION 3) ---
        // CHANGED: Version 2 -> 3
        function openDB(){return new Promise(r=>{const q=indexedDB.open("BarpathDB",3);q.onsuccess=e=>r(e.target.result);q.onerror=()=>r(null)})}
        
        async function getDataFromDB(store, id) {
            try {
                const db = await openDB();
                if(!db) return null;
                return new Promise(r => {
                    const tx = db.transaction(store, "readonly");
                    const req = tx.objectStore(store).get(id);
                    req.onsuccess = () => r(req.result);
                    req.onerror = () => r(null);
                });
            } catch(e) { return null; }
        }

        const GRAPH_INFO = {
            'barbell_xy_stable_path': { 
                title: 'Bar Path Trajectory', 
                desc: 'Top-down view of the bar\'s movement. The ideal path is nearly vertical. Loops or horizontal curves indicate inefficiency (swinging the bar away).' 
            },
            'barbell_lateral_corrected_path': { 
                title: 'Perspective Corrected Path', 
                desc: 'This removes the camera angle distortion to show the TRUE bar path. Use this to judge if you are actually pulling straight or swinging.' 
            },
            'vel_y_smooth': { 
                title: 'Vertical Velocity', 
                desc: 'How fast the bar moves up. For Cleans/Snatches, look for two distinct peaks (1st & 2nd pull). A crash to zero between them means you stopped pulling.' 
            },
            'accel_y_smooth': { 
                title: 'Vertical Acceleration', 
                desc: 'Measures Force (F=ma). Sharp spikes here correspond to your explosive "drive" against the floor. Higher spikes = more explosive power.' 
            },
            'specific_power_y_smooth': { 
                title: 'Specific Power', 
                desc: 'Your Power-to-Weight ratio. This is the ultimate measure of explosiveness relative to the system mass. Sustained high power is key for heavy lifts.' 
            },
            'barbell_xy_stable_path_unsmoothed': { 
                title: 'Raw Tracking Data', 
                desc: 'The raw, unfiltered detection data. Useful for debugging if the "Smooth" path looks artificial or over-corrected.' 
            }
        };

        (async function init() {
            const rawMeta = localStorage.getItem('lastResultMeta');
            const container = document.getElementById('content');

            if (!rawMeta) { container.innerHTML = `<div class="text-center text-gray-500 mt-10">No data found. Upload a video first.</div>`; return; }

            const data = JSON.parse(rawMeta);
            const liftId = parseInt(localStorage.getItem('lastResultId'));
            
            // Fetch Heavy Data from DB
            const videoBase64 = await getDataFromDB("videos", liftId);
            const graphs = await getDataFromDB("graphs", liftId) || {};

            const m = data.metrics || {};
            
            // Video Player
            let videoHtml = videoBase64 ? `
                <div class="fade-in mb-6 rounded-3xl overflow-hidden shadow-2xl border border-gray-800 bg-black aspect-[9/16] relative">
                    <video controls autoplay loop muted playsinline class="w-full h-full object-contain">
                        <source src="data:video/mp4;base64,${videoBase64}" type="video/mp4">
                    </video>
                    <div class="absolute top-4 left-4 glass-panel px-3 py-1 rounded-full text-[10px] font-bold tracking-wider flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> AI OVERLAY
                    </div>
                </div>` : `<div class="p-4 bg-red-900/20 text-red-400 rounded-xl text-center mb-6">Video storage limit reached.</div>`;

            // Metrics
            const metricsHtml = `
            <div class="grid grid-cols-2 gap-3 mb-8 fade-in delay-100">
                <div class="glass-panel p-4 rounded-2xl">
                    <div class="text-gray-500 text-[10px] uppercase font-bold mb-1">Peak Velocity</div>
                    <div class="text-2xl font-bold text-blue-400">${Math.round(m.peak_velocity || 0)} <span class="text-xs text-gray-500">px/s</span></div>
                </div>
                <div class="glass-panel p-4 rounded-2xl">
                    <div class="text-gray-500 text-[10px] uppercase font-bold mb-1">Duration</div>
                    <div class="text-2xl font-bold text-white">${(m.duration || 0).toFixed(2)} <span class="text-xs text-gray-500">s</span></div>
                </div>
                <div class="glass-panel p-4 rounded-2xl">
                    <div class="text-gray-500 text-[10px] uppercase font-bold mb-1">Technique Score</div>
                    <div class="text-2xl font-bold text-green-400">${Math.round(m.technique_score || 0)}</div>
                </div>
                 <div class="glass-panel p-4 rounded-2xl">
                    <div class="text-gray-500 text-[10px] uppercase font-bold mb-1">Cam Angle</div>
                    <div class="text-2xl font-bold text-purple-400">~45<span class="text-xs text-gray-500">Â°</span></div>
                </div>
            </div>`;

            // Graphs
            let graphsHtml = '<div class="space-y-6 pb-8 fade-in delay-200">';
            Object.keys(graphs).forEach(key => {
                const info = GRAPH_INFO[key] || { title: key, desc: 'Analysis Graph' };
                graphsHtml += `
                <div class="glass-panel rounded-3xl overflow-hidden">
                    <div class="p-4 border-b border-white/5 bg-white/5">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i data-lucide="activity" class="w-4 h-4 text-blue-500"></i> ${info.title}
                        </h3>
                        <p class="text-xs text-gray-500 mt-1">${info.desc}</p>
                    </div>
                    <div class="p-4 bg-white/95">
                        <img src="data:image/png;base64,${graphs[key]}" class="w-full h-auto rounded-lg mix-blend-multiply">
                    </div>
                </div>`;
            });
            graphsHtml += '</div>';

            container.innerHTML = videoHtml + metricsHtml + graphsHtml;
            lucide.createIcons();
        })();
    </script>
</body>
</html>