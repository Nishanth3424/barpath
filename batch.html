<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch - Barpath Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.1); --glass-bg: rgba(20, 20, 25, 0.7); }
        body { font-family: -apple-system, sans-serif; background: #000; color: white; overflow-x: hidden; }
        .mesh-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle at 50% 100%, #1a237e 0%, #000000 70%); z-index: -1; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
    </style>
</head>
<body class="pb-24">
    <div class="mesh-bg"></div>

    <div class="max-w-lg mx-auto px-6 py-8">
        <div class="flex items-center gap-4 mb-8">
            <button onclick="window.location.href='index.html'" class="p-3 rounded-full hover:bg-white/10 glass-panel">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h1 class="text-2xl font-bold tracking-tight">Batch Analysis</h1>
        </div>

        <div class="glass-panel p-4 rounded-2xl mb-6 flex gap-3 items-start border-blue-500/30 bg-blue-900/10">
            <i data-lucide="layers" class="w-5 h-5 text-blue-400 mt-0.5"></i>
            <div class="text-sm text-blue-200">
                <strong>Pro Feature:</strong> Process multiple videos sequentially. Results are saved to History automatically.
            </div>
        </div>

        <div onclick="document.getElementById('batchInput').click()" class="glass-panel border-dashed border-2 border-white/20 rounded-[32px] p-8 text-center cursor-pointer hover:bg-white/5 transition-all mb-8">
            <input type="file" id="batchInput" multiple accept="video/*" class="hidden">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-purple-600/20 flex items-center justify-center">
                <i data-lucide="copy-plus" class="w-8 h-8 text-purple-400"></i>
            </div>
            <p class="font-bold text-lg mb-1">Select Multiple Videos</p>
            <p class="text-xs text-gray-500">Queue them up for auto-processing</p>
        </div>

        <button id="processBtn" onclick="processQueue()" disabled class="w-full py-4 bg-gray-800 text-gray-500 font-bold rounded-2xl transition-all shadow-lg mb-8 flex items-center justify-center gap-2">
            Waiting for videos...
        </button>

        <div id="queueList" class="space-y-3"></div>
    </div>

    <script>
        lucide.createIcons();
        const API_URL = 'https://gamercheetah24--barpath-analyzer-v2-web.modal.run/api';
        let queue = [];
        let isProcessing = false;
        
        // --- DB HELPERS (Version 3) ---
        function openDB(){return new Promise(r=>{const q=indexedDB.open("BarpathDB",3);q.onsuccess=e=>r(e.target.result);q.onerror=()=>r(null)})}

        document.getElementById('batchInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                queue.push({ 
                    id: Math.random().toString(36).substr(2,9), 
                    file, 
                    status: 'pending', 
                    error: null 
                });
            });
            renderQueue();
            updateProcessBtn();
        });

        function renderQueue() {
            const list = document.getElementById('queueList');
            if (queue.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-600 text-sm">Queue is empty</div>`;
                return;
            }
            
            list.innerHTML = queue.map((item, index) => `
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${getStatusColor(item.status)} bg-opacity-20">
                            ${getStatusIcon(item.status)}
                        </div>
                        <div class="min-w-0">
                            <div class="font-medium text-sm truncate w-40">${item.file.name}</div>
                            <div class="text-[10px] uppercase font-bold tracking-wider ${getStatusTextColor(item.status)}">${item.status}</div>
                        </div>
                    </div>
                    ${item.status === 'pending' && !isProcessing ? `
                        <button onclick="removeFromQueue(${index})" class="p-2 hover:bg-white/10 rounded-full">
                            <i data-lucide="x" class="w-4 h-4 text-gray-400"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function getStatusColor(s) {
            if(s==='pending') return 'bg-gray-500';
            if(s==='processing') return 'bg-blue-500 animate-pulse';
            if(s==='complete') return 'bg-green-500';
            return 'bg-red-500';
        }
        function getStatusTextColor(s) {
            if(s==='pending') return 'text-gray-500';
            if(s==='processing') return 'text-blue-400';
            if(s==='complete') return 'text-green-400';
            return 'text-red-400';
        }
        function getStatusIcon(s) {
            if(s==='pending') return '<div class="w-2 h-2 bg-gray-400 rounded-full"></div>';
            if(s==='processing') return '<i data-lucide="loader-2" class="w-4 h-4 text-blue-400 animate-spin"></i>';
            if(s==='complete') return '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>';
            return '<i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>';
        }

        function removeFromQueue(i) { queue.splice(i, 1); renderQueue(); updateProcessBtn(); }

        function updateProcessBtn() {
            const btn = document.getElementById('processBtn');
            const pending = queue.filter(i => i.status === 'pending').length;
            
            if (isProcessing) {
                btn.textContent = "Processing...";
                btn.className = "w-full py-4 bg-blue-600/50 text-white font-bold rounded-2xl cursor-wait";
                btn.disabled = true;
            } else if (pending > 0) {
                btn.textContent = `Start Batch (${pending})`;
                btn.className = "w-full py-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-2xl shadow-lg shadow-purple-900/50";
                btn.disabled = false;
            } else {
                btn.textContent = "Add Videos to Start";
                btn.className = "w-full py-4 bg-gray-800 text-gray-500 font-bold rounded-2xl";
                btn.disabled = true;
            }
        }

        function readFile(file) {
            return new Promise((resolve) => {
                const r = new FileReader();
                r.onload = () => resolve(r.result.split(',')[1]);
                r.readAsDataURL(file);
            });
        }

        async function processQueue() {
            if (isProcessing) return;
            isProcessing = true;
            updateProcessBtn();

            for (let i = 0; i < queue.length; i++) {
                if (queue[i].status !== 'pending') continue;
                
                queue[i].status = 'processing';
                renderQueue();

                try {
                    const b64 = await readFile(queue[i].file);
                    
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            video: b64, 
                            lift_type: 'clean', 
                            filename: queue[i].file.name 
                        })
                    });
                    const data = await res.json();

                    if (data.success) {
                        queue[i].status = 'complete';
                        
                        // Save Result (Lightweight only for Batch)
                        const history = JSON.parse(localStorage.getItem('liftHistory') || '[]');
                        const lightResult = { ...data };
                        delete lightResult.rendered_video; // Too big for batch
                        delete lightResult.graphs;         // Too big for batch
                        
                        history.unshift({
                            id: Date.now() + i,
                            date: new Date().toISOString(),
                            lift: 'clean',
                            score: Math.round(data.metrics?.technique_score || 0),
                            velocity: Math.round(data.metrics?.peak_velocity || 0),
                            duration: (data.metrics?.duration || 0).toFixed(1),
                            resultData: lightResult
                        });
                        localStorage.setItem('liftHistory', JSON.stringify(history.slice(0, 20)));
                    } else {
                        queue[i].status = 'error';
                    }
                } catch (e) {
                    queue[i].status = 'error';
                }
                renderQueue();
            }
            isProcessing = false;
            updateProcessBtn();
        }
    </script>
</body>
</html>